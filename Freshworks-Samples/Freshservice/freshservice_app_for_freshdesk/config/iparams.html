<html>
  <head>
    <script src="https://static.freshdev.io/fdk/2.0/assets/fresh_client.js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://static.freshdev.io/fdk/2.0/assets/freshservice.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/1.3.0/spin.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/1.3.0/spin.min.js"></script>
    <style>
      .domain-name-field {
        width: 450px;
      }

      .api-key-field {
        width: 438px;
      }

      .form-actions {
        margin-top: 10px;
        margin-right: 10px;
        float: right;
      }

      .field-tip {
        color: grey;
        font-size: 12px;
        margin-top: 5px;
        display: inline-block;
      }

      .hide-element {
        display: none;
      }

      .validation {
        color: red;
      }

      #danger-message {
        display: none;
      }

      .list-group-item {
        display: flex;
        border-right: none;
        border-left: none;
      }

      li.list-group-item select,
      li.list-group-item input {
        margin-right: 10px;
      }

      li.list-group-item .delete-key {
        color: #fff;
        padding: 0px 5px;
        background-color: red;
        border-radius: 50%;
        text-decoration: none;
        cursor: pointer;
        margin-right: 10px;
        height: 20px;
        margin-top: 5px;
      }

      .list-group-item:first-child {
        border-top-right-radius: 0px;
        border-top-left-radius: 0px;
      }

      .rule-top-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        align-content: center;
      }

      .add-new-rule,
      .remove-rule {
        list-style: none;
        text-decoration: none;
      }

      .remove-rule {
        cursor: pointer;
        text-decoration: none;
        margin-right: 10px;
        color: red;
      }

      .remove-rule:hover {
        text-decoration: none;
        color: red;
      }

      .add-new-rule:hover,
      #add-new-rule:hover {
        cursor: pointer;
        text-decoration: none;
      }

      .row {
        margin-left: 0px;
        margin-right: 0px;
      }

      .ml-10 {
        margin-left: 10px !important;
      }

      .ml-30 {
        margin-left: 30px !important;
      }

      .mb-15 {
        margin-bottom: 15px !important;
      }

      .mb-20 {
        margin-bottom: 20px !important;
      }

      .mb-30 {
        margin-bottom: 30px !important;
      }

      .pl-10 {
        padding-left: 10px;
      }

      .pl-20 {
        padding-left: 20px;
      }

      .pr-15 {
        padding-right: 15px;
      }

      .pt-10 {
        padding-top: 10px;
      }

      .flex {
        display: flex;
      }

      #sync_settings select {
        width: 250px;
      }

      #sync_settings h6 {
        font-size: 12px;
        margin-bottom: 35px;
        margin-top: 15px;
      }

      label {
        font-size: 12px;
        margin-bottom: 5px;
      }

      select {
        height: 25px;
        font-size: 12px;
      }

      input[type="checkbox"] {
        top: 2px;
      }

      #is_add_private_note:checked:before {
        left: 2px;
        top: -1px;
      }

      h4 {
        font-weight: 400;
      }

      h5 {
        padding-top: 10px;
        font-weight: 600;
      }

      h6 {
        font-size: 13px;
      }

      hr {
        margin-top: 15px;
        margin-bottom: 10px;
        border-top: 1px solid #dadfe3;
      }

      #set_rules h5 {
        font-weight: 400;
        padding-bottom: 10px;
      }

      .badge {
        color: #444;
        background-color: #ebeef1;
        font-weight: 400;
        padding-bottom: 4px;
        white-space: inherit;
        word-break: break-word;
      }

      .input-group-addon {
        position: relative;
        left: -25px;
        line-height: 0.75;
      }

      #iparams_authenticate,
      #after_select_rule {
        outline: none !important;
        background-color: #02a468;
        border: 1px #03a86b solid;
      }

      #is_add_private_note {
        outline: none !important;
      }

      #auth_fields input[type="text"]:focus + .input-group-addon {
        border-color: #02b875;
        outline: none !important;
      }

      .fs_mandatory_fields {
        margin-bottom: 15px;
      }

      .required {
        color: #d00;
        font-weight: bold;
        font-size: 12px;
        margin-left: 2px;
        display: inline-block;
      }

      .helper-text {
        font-size: 12px;
        color: #aaa;
      }

      #spinner_widget {
        padding: 20px 5px;
      }

      input[type="checkbox"]:checked {
        background: #02b875;
        border: 3px solid #02b875;
      }
    </style>
  </head>

  <body>
    <div class="ml-30">
      <div class="alert alert-danger" id="danger-message"></div>
      <div id="auth_fields">
        <h4>Freshdesk - Freshservice Auth Settings</h4>
        <h5>Freshdesk account details</h5>
        <div class="input-section domain-name-field">
          <label> Enter your Freshdesk Subdomain</label>
          <div class="input-group">
            <input id="fd_subdomain" type="text" />
            <span class="input-group-addon">.freshdesk.com</span>
          </div>
          <span class="field-tip">
            <i class="icon-question"></i>
            subdomain should be in the format subdomain.freshdesk.com
          </span>
        </div>
        <div class="input-section api-key-field">
          <label> Enter your Freshdesk's admin API Key</label>
          <input value="" id="fd_api_key" type="text" />
          <span class="field-tip">
            <i class="icon-question"></i>
            you can find the API key under profile settings
          </span>
        </div>
        <hr />
        <h5>Freshservice account details</h5>
        <div class="input-section domain-name-field">
          <label> Enter your Freshservice Subdomain</label>
          <div class="input-group">
            <input value="" id="fs_subdomain" type="text" />
            <span class="input-group-addon">.freshservice.com</span>
          </div>
          <span class="field-tip">
            <i class="icon-question"></i>
            subdomain should be in the format subdomain.freshservice.com
          </span>
        </div>
        <div class="input-section api-key-field">
          <label> Enter your Freshservice's admin API Key</label>
          <input value="" id="fs_api_key" type="text" />
          <span class="field-tip">
            <i class="icon-question"></i>
            you can find the API key under profile settings
          </span>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" id="iparams_authenticate">
            Authenticate
          </button>
        </div>
      </div>
      <div id="set_rules">
        <h4>Ticket Flow Settings</h4>
        <h5>Set rules for outgoing tickets from Freshdesk</h5>
        <div class="form-group" id="rule_container"></div>
        <li class="add-new-rule mb-20">
          <a id="add-new-rule">+ Add New Condition</a>
        </li>

        <div id="fs_mandatory_fields">
          <div class="spin" id="spinner_widget"></div>
        </div>

        <div class="input-section">
          <input
            type="checkbox"
            name="is_add_private_note"
            id="is_add_private_note"
            value=""
          />
          <span class="ml-10"
            >Add existing conversation from Freshdesk as private note in
            Freshservice</span
          >
        </div>
        <div class="form-actions mb-30">
          <button class="btn btn-primary" id="after_select_rule">Next</button>
        </div>
      </div>
      <div id="sync_settings" class="mb-20">
        <h4>Sync Updates</h4>
        <h6>
          When a corresponding Freshservice ticket is created for a Freshdesk
          ticket perform below actions
        </h6>
        <div class="row mb-20 pt-10">
          <label class="col-lg-6 col-md-6 col-sm-6 col-xs-6">
            When ticket status is updated in Freshdesk</label
          >
          <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6">
            <select id="fd_status_updated">
              <option value="add_private_note_in_fs">
                Add a Private Note in Freshservice ticket
              </option>
              <option value="do_nothing">Do nothing</option>
            </select>
          </div>
        </div>
        <div class="row mb-20">
          <label class="col-lg-6 col-md-6 col-sm-6 col-xs-6">
            When a note is added in Freshdesk</label
          >
          <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6">
            <select id="fd_note_added">
              <option value="add_private_note_in_fs">
                Add a Private Note in Freshservice ticket
              </option>
              <option value="do_nothing">Do nothing</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    var _this = this;
    var authFormFields = [
      "fd_subdomain",
      "fd_api_key",
      "fs_subdomain",
      "fs_api_key",
    ];
    var syncFields = ["fd_status_updated", "fd_note_added"];
    var fd_subdomain,
      fs_subdomain,
      fd_api_key,
      fs_api_key,
      fs_base_url,
      fd_base_url,
      fdTicketProperties = [],
      fsTicketProperties = [],
      isFdAuthenticated = false,
      isFsAuthenticated = false,
      isRuleSet = false,
      ruleMap = {},
      fsMandatoryTktFields = {},
      fsMandatoryFields = [],
      allAgents = [],
      isDepartmentMandatory = false,
      page_no = 1;

    function getConfigs(savedConfigs) {
      if (savedConfigs) {
        authFormFields.forEach(function (key) {
          document.getElementById(`${key}`).value = savedConfigs[key];
        });

        syncFields.forEach(function (key) {
          document.getElementById(`${key}`).value = savedConfigs[key];
        });

        document.getElementById(`${"ruleMap"}`).value = savedConfigs["ruleMap"];
        ruleMap = savedConfigs["ruleMap"];

        fsMandatoryTktFields = savedConfigs["fsMandatoryFields"];
      }
    }

    function postConfigs() {
      let config = {};
      fsMandatoryTktFields = {};

      authFormFields.forEach(function (key) {
        config[key] = document.getElementById(`${key}`).value;
      });

      syncFields.forEach(function (key) {
        config[key] = document.getElementById(`${key}`).value;
      });

      fsMandatoryFields.forEach(function (key) {
        fsMandatoryTktFields[key.id] = {
          value:
            key.type == "custom_checkbox"
              ? document.getElementById(`${key.id}`).getAttribute("checked")
              : document.getElementById(`${key.id}`).value,
          type: key.type,
          name: key.name,
        };
      });

      fsMandatoryTktFields["is_department_manadatory"] = {
        value: isDepartmentMandatory ? true : false,
      };

      config["fsMandatoryFields"] = fsMandatoryTktFields;
      config["ruleMap"] = ruleMap;
      return config;
    }

    function validate() {
      let isValid = false;
      if (isFdAuthenticated && isFsAuthenticated && isRuleSet) {
        isValid = true;
      }
      return isValid;
    }

    function authFormValidation() {
      let isValid = true;
      authFormFields.forEach(function (field) {
        if (!document.getElementById(`${field}`).value) {
          isValid = false;
        }
      });
      return isValid;
    }

    function mandatoryFieldValidation() {
      let isValid = true;
      fsMandatoryFields.forEach(function (field) {
        if (!document.getElementById(`${field.id}`).value) {
          isValid = false;
        }
      });
      return isValid;
    }

    function showRuleFields() {
      document.getElementById("auth_fields").style.display = "none";
      document.getElementById("set_rules").style.display = "block";

      for (var rule in ruleMap) {
        if (rule.indexOf("rule_") != -1) {
          _this.addNewRule(ruleMap[rule]);
        } else {
          document
            .getElementById("is_add_private_note")
            .setAttribute("checked", ruleMap[rule]);
        }
      }
      _this.loadspinner();
      _this.getMandatoryFieldsList();
    }

    document.getElementById("auth_fields").style.display = "none";
    document.getElementById("set_rules").style.display = "none";
    document.getElementById("sync_settings").style.display = "none";

    document.getElementById("after_select_rule").setAttribute("disabled", true);

    document
      .getElementById("iparams_authenticate")
      .addEventListener("click", function (ev) {
        var isValid = _this.authFormValidation();
        fd_subdomain = document.getElementById("fd_subdomain").value;
        fd_api_key = document.getElementById("fd_api_key").value;

        fs_subdomain = document.getElementById("fs_subdomain").value;
        fs_api_key = document.getElementById("fs_api_key").value;

        fd_base_url = "https://" + fd_subdomain + ".freshdesk.com";
        fs_base_url = "https://" + fs_subdomain + ".freshservice.com";

        if (isValid) {
          var fsUrl = fs_base_url + "/api/v2/ticket_fields";
          var fsOptions = {
            headers: {
              Authorization: "Basic " + btoa(fs_api_key + ":x"),
              "Content-Type": "application/json",
              Accept: "application/json",
            },
          };

          var fdUrl = fd_base_url + "/api/v2/ticket_fields";
          var fdOptions = {
            headers: {
              Authorization: "Basic " + btoa(fd_api_key + ":x"),
              "Content-Type": "application/json",
              Accept: "application/json",
            },
          };

          Promise.all([
            client.request.get(fsUrl, fsOptions).then(
              function (data) {
                fsTicketProperties = JSON.parse(data.response);
                isFsAuthenticated = true;
              },
              function (error) {
                showError(
                  "Could not verify api key. Please check domain name and API key for Freshservice."
                );
                isFsAuthenticated = false;
              }
            ),
            client.request.get(fdUrl, fdOptions).then(
              function (data) {
                fdTicketProperties = JSON.parse(data.response);
                isFdAuthenticated = true;
              },
              function (error) {
                showError(
                  "Could not verify api key. Please check domain name and API key for Freshdesk."
                );
                isFdAuthenticated = false;
              }
            ),
          ]).then(function () {
            if (isFdAuthenticated && isFsAuthenticated) {
              _this.showRuleFields("rule_container");
            }
          });
        } else {
          showError(
            'Please fill the "Domain Name" and "API key" for freshdesk and freshservice'
          );
        }
      });

    function getMandatoryFieldsList() {
      var isAgentManadatory = false;
      var mandatoryFieldsList = [];
      var excludeFieldsList = [
        "default_requester",
        "default_subject",
        "default_status",
        "default_priority",
        "default_description",
        "default_source",
        "default_urgency",
        "default_impact",
      ];
      var mandatoryFields = fsTicketProperties.ticket_fields.filter(
        (item) => item.required_for_agents == true
      );
      mandatoryFields.forEach((property) => {
        if (excludeFieldsList.indexOf(property.type) == -1) {
          if (property.type == "default_department") {
            isDepartmentMandatory = true;
          } else {
            if (property.type == "default_agent") {
              isAgentManadatory = true;
            }
            mandatoryFieldsList.push({
              id: property.id,
              name: property.name,
              label: property.label,
              type: property.type,
              fieldId: property.default
                ? "default_" + property.name
                : "custom_" + property.name,
            });
          }
        }
      });

      if (isAgentManadatory) {
        _this.getAllAgents(mandatoryFieldsList);
      } else {
        _this.showFSMandatoryFields(mandatoryFieldsList);
      }
    }

    function getAllAgents(mandatoryFieldsList) {
      var fsAllAgentsURL = fs_base_url + "/api/v2/agents?page=" + page_no;
      var fsOptions = {
        headers: {
          Authorization: "Basic " + btoa(fs_api_key + ":x"),
          "Content-Type": "application/json",
          Accept: "application/json",
        },
      };

      client.request
        .get(fsAllAgentsURL, fsOptions)
        .then(
          function (data) {
            var agentsData = JSON.parse(data.response);
            if (agentsData.agents.length) {
              Array.prototype.push.apply(allAgents, agentsData.agents);
              page_no++;
              _this.getAllAgents(mandatoryFieldsList);
            } else {
              _this.showFSMandatoryFields(mandatoryFieldsList);
            }
          },
          function (error) {
            showError("Error in fetching Agent list.");
          }
        )
        .then(function () {
          // Dont do anything
        });
    }

    function showFSMandatoryFields(mandatoryFieldsList) {
      var elementHTML =
        "<h6>Freshservice Mandatory Ticket Fields<span class ='required'>*</span></h6>";
      if (mandatoryFieldsList.length > 0) {
        mandatoryFieldsList.forEach((field) => {
          elementHTML =
            elementHTML +
            '<li class="row list-group-item" id="' +
            field.fieldId +
            '">' +
            '<div class="col-lg-5 col-md-5 col-sm-5 col-xs-5">' +
            '<span class="badge col-lg-7 col-md-7 col-sm-7 col-xs-7">' +
            field.label +
            "</span>" +
            '<span class="pl-10 pr-15">is</span>' +
            "</div>" +
            getValueField(field) +
            "</li>";
        });

        document.getElementById("fs_mandatory_fields").innerHTML = elementHTML;

        //populating mandatory ticket fields with old values
        for (var key in fsMandatoryTktFields) {
          if (fsMandatoryTktFields[key].type == "custom_checkbox") {
            document
              .getElementById(`${key}`)
              .setAttribute("checked", fsMandatoryTktFields[key].value);
          } else {
            document.getElementById(`${key}`).value =
              fsMandatoryTktFields[key].value;
          }
        }

        // setting agent field value based on group selected
        var selectedGrpId = document.querySelector(
          "li#default_group select"
        ).value;
        if (selectedGrpId) {
          setAgentFieldValue(selectedGrpId);
        }
      } else {
        elementHTML =
          elementHTML +
          '<div class="helper-text">There are no mandatory fields in Freshservice</div>';
        document.getElementById("fs_mandatory_fields").innerHTML = elementHTML;
      }

      document
        .getElementById("after_select_rule")
        .setAttribute("disabled", false);
    }

    function getValueField(field) {
      var valueFieldHtml = "";
      var escapedText;
      var currentField = fsTicketProperties.ticket_fields.filter(
        (item) => item.id == field.id
      )[0];
      var dropdownFieldsList = [
        "custom_dropdown",
        "default_agent",
        "default_group",
        "ticket_type",
        "default_category",
        "nested_field",
      ];
      var fieldTypeMap = {
        custom_number: "number",
        custom_decimal: "number",
        custom_date: "date",
        custom_checkbox: "checkbox",
        custom_paragraph: "text",
        custom_text: "text",
      };

      if (dropdownFieldsList.includes(field.type)) {
        if (field.type == "default_agent") {
          currentField.choices = allAgents;
        }

        valueFieldHtml =
          '<select class="col-lg-5 col-md-5 col-sm-5 col-xs-5" id="' +
          field.fieldId +
          '_value">';

        for (var key in currentField.choices) {
          switch (currentField.type) {
            case "default_group":
              valueFieldHtml =
                valueFieldHtml +
                '<option value="' +
                currentField.choices[key] +
                '">' +
                key +
                "</option>";
              break;

            case "default_category":
            case "nested_field":
              escapedText = key
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
              valueFieldHtml =
                valueFieldHtml +
                '<option value="' +
                escapedText +
                '">' +
                key +
                "</option>";
              break;

            case "default_agent":
              var agent = currentField.choices[key];
              var agentName =
                agent.first_name +
                " " +
                (agent.last_name ? agent.last_name : "");
              valueFieldHtml =
                valueFieldHtml +
                '<option value="' +
                agent.id +
                '">' +
                agentName +
                "</option>";
              break;

            case "custom_dropdown":
              escapedText = currentField.choices[key]
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
              valueFieldHtml =
                valueFieldHtml +
                '<option value="' +
                escapedText +
                '">' +
                currentField.choices[key] +
                "</option>";
              break;

            default:
              valueFieldHtml =
                valueFieldHtml +
                '<option value="' +
                key +
                '">' +
                currentField.choices[key] +
                "</option>";
              break;
          }
        }

        valueFieldHtml = valueFieldHtml + "</select>";
      } else {
        valueFieldHtml =
          '<input type="' +
          fieldTypeMap[field.type] +
          '" class="col-lg-5 col-md-5 col-sm-5 col-xs-5" id="' +
          field.fieldId +
          '_value"/>';
      }

      fsMandatoryFields.push({
        id: field.fieldId + "_value",
        type: field.type,
        name: field.name,
      });

      return valueFieldHtml;
    }

    function setAgentFieldValue(selectedGrpId) {
      var agentListForGrp = [];
      allAgents.forEach((agent) => {
        agent.group_ids.forEach((grpId) => {
          if (grpId == selectedGrpId) {
            agentListForGrp.push(agent);
          }
        });
      });
      const selectElement = document.querySelector("li#default_agent select");
      while (selectElement.firstChild) {
        selectElement.removeChild(selectElement.firstChild);
      }

      var optionHtml = "";
      for (var key in agentListForGrp) {
        var agentName =
          agentListForGrp[key].first_name +
          " " +
          (agentListForGrp[key].last_name
            ? agentListForGrp[key].last_name
            : "");
        optionHtml =
          optionHtml +
          '<option value="' +
          agentListForGrp[key].id +
          '">' +
          agentName +
          "</option>";
      }
      document
        .querySelector("li#default_agent select")
        .insertAdjacentHTML("beforeend", optionHtml);
    }

    document
      .querySelector("body li#default_group")
      .addEventListener("change", function (ev) {
        var selectedGrpId = this.querySelector("select").value;
        var isAgentMandatory = fsTicketProperties.ticket_fields.filter(
          (item) =>
            item.required_for_agents == true && item.type == "default_agent"
        );
        if (isAgentMandatory) {
          setAgentFieldValue(selectedGrpId);
        }
      });

    document
      .getElementById("add-new-rule")
      .addEventListener("click", function (ev) {
        _this.addNewRule();
      });

    function getFieldsList() {
      var namelist = [];
      var acceptedFieldList = [
        "default_status",
        "default_group",
        "default_ticket_type",
      ];
      fdTicketProperties.forEach((property) => {
        if (acceptedFieldList.indexOf(property.type) != -1) {
          namelist.push({
            id: property.id,
            name: property.name,
            label: property.label,
            type: property.field_type,
          });
        }
      });
      return namelist;
    }

    function addNewRule(rule) {
      var namelist = getFieldsList();
      var prop = "";

      namelist.forEach((element) => {
        prop =
          prop +
          '<option value="' +
          element.name +
          '">' +
          element.label +
          "</option>";
      });

      var ul_count = document.querySelectorAll("#rule_container ul").length + 1;
      var ruleElement =
        '<div id="rule_inner_container"><div class="rule-top-content"><h6 id = "rule_' +
        ul_count +
        '">Rule ' +
        ul_count +
        '</h6><a class="remove-rule" id="remove_rule_' +
        ul_count +
        '">- Remove Rule</a></div><ul class="list-group" id="rule_' +
        ul_count +
        '">';

      ruleElement =
        ruleElement +
        '<li class="row list-group-item" id="rule_' +
        ul_count +
        '_group">' +
        '<div class="col-lg-5 col-md-5 col-sm-5 col-xs-5">' +
        '<span class="badge col-lg-7 col-md-7 col-sm-7 col-xs-7">Group</span>' +
        '<span class="pl-10 pr-15">is</span>' +
        "</div>" +
        '<select class="col-lg-5 col-md-5 col-sm-5 col-xs-5" name="group">' +
        (rule
          ? getOptions("default_group", rule.group)
          : getOptions("default_group")) +
        "</select>" +
        "</li>" +
        '<li class="row list-group-item" id="rule_' +
        ul_count +
        '_status">' +
        '<div class="col-lg-5 col-md-5 col-sm-5 col-xs-5">' +
        '<span class="badge col-lg-7 col-md-7 col-sm-7 col-xs-7">Status</span>' +
        '<span class="pl-10 pr-15">is</span>' +
        "</div>" +
        '<select class="col-lg-5 col-md-5 col-sm-5 col-xs-5" name="status">' +
        (rule
          ? getOptions("default_status", rule.status)
          : getOptions("default_status")) +
        "</select>" +
        "</li>" +
        '<li class="row list-group-item" id="rule_' +
        ul_count +
        '_type">' +
        '<div class="col-lg-5 col-md-5 col-sm-5 col-xs-5">' +
        '<span class="badge col-lg-7 col-md-7 col-sm-7 col-xs-7">Type</span>' +
        '<span class="pl-10 pr-15">is</span>' +
        "</div>" +
        '<select class="col-lg-5 col-md-5 col-sm-5 col-xs-5" name="type">' +
        (rule
          ? getOptions("default_ticket_type", rule.type)
          : getOptions("default_ticket_type")) +
        "</select>" +
        "</li>" +
        "</ul>" +
        "</div>";

      document
        .getElementById("rule_container")
        .insertAdjacentHTML("beforeend", ruleElement);
    }

    function getOptions(property_type, old_rule_value) {
      var optionValues = fdTicketProperties.filter(
        (item) => item.type == property_type
      )[0].choices;
      var options = "";

      if (property_type == "default_status") {
        for (var option in optionValues) {
          if (old_rule_value) {
            options =
              options +
              '<option value="' +
              option +
              '"' +
              (old_rule_value == option ? " selected>" : ">") +
              optionValues[option][0] +
              "</option>";
          } else {
            options =
              options +
              '<option value="' +
              option +
              '">' +
              optionValues[option][0] +
              "</option>";
          }
        }
      } else if (property_type == "default_group") {
        for (var option in optionValues) {
          if (old_rule_value) {
            options =
              options +
              '<option value="' +
              optionValues[option] +
              '"' +
              (old_rule_value == optionValues[option] ? " selected>" : ">") +
              option +
              "</option>";
          } else {
            options =
              options +
              '<option value="' +
              optionValues[option] +
              '">' +
              option +
              "</option>";
          }
        }
      } else if (property_type == "default_ticket_type") {
        for (var option in optionValues) {
          if (old_rule_value) {
            options =
              options +
              '<option value="' +
              optionValues[option] +
              '"' +
              (old_rule_value == optionValues[option] ? " selected>" : ">") +
              optionValues[option] +
              "</option>";
          } else {
            options =
              options +
              '<option value="' +
              optionValues[option] +
              '">' +
              optionValues[option] +
              "</option>";
          }
        }
      }

      options = options + "+";
      return options;
    }

    document
      .querySelector("body .remove-rule")
      .addEventListener("click", function (element) {
        this.querySelector("#rule_inner_container").remove();

        document
          .querySelectorAll("#rule_container #rule_inner_container")
          .forEach(function (element, i) {
            var new_id = i + 1;
            currentThis
              .querySelector("h6")
              .setAttribute("id", "rule_" + new_id);
            currentThis.querySelector("h6").innerText = "Rule " + new_id;
            currentThis
              .querySelector(".remove-rule")
              .setAttribute("id", "remove_rule_" + new_id);

            currentThis.querySelectorAll("ul").forEach(function () {
              currentThis.setAttribute("id", "rule_" + new_id);

              currentThis
                .querySelector("li select[name=status]")
                .setAttribute("id", "rule_" + new_id + "_status");
              currentThis
                .querySelector("select[name=status]")
                .closest("li")
                .setAttribute("id", "rule_" + new_id + "_status");

              currentThis
                .querySelector("li select[name=group]")
                .setAttribute("id", "rule_" + new_id + "_group");
              currentThis
                .querySelector("select[name=group]")
                .closest("li")
                .setAttribute("id", "rule_" + new_id + "_group");

              currentThis
                .querySelector("li select[name=type]")
                .setAttribute("id", "rule_" + new_id + "_type");
              currentThis
                .querySelector("select[name=type]")
                .closest("li")
                .setAttribute("id", "rule_" + new_id + "_type");
            });
          }, currentThis);
      });

    document
      .getElementById("after_select_rule")
      .addEventListener("click", function () {
        var isMandatoryFieldsValid = _this.mandatoryFieldValidation();
        if (isMandatoryFieldsValid) {
          ruleMap = {};
          document
            .querySelectorAll("#rule_container ul")
            .forEach(function (element, i) {
              var status, group, type;
              var ruleName = document
                .getElementById("rule_inner_container")
                .querySelector("h6")
                .getAttribute("id");
              ruleMap[ruleName] = {
                status: currentThis.querySelector("li select[name=status]")
                  .value,
                group: currentThis.querySelector("li select[name=group]").value,
                type: currentThis.querySelector("li select[name=type]").value,
              };
            }, "currentThis");

          ruleMap["add_private_note"] = document
            .getElementById("input[name=is_add_private_note]")
            .getAttribute("checked");

          document.getElementById("set_rules").style.display = "none";
          document.getElementById("sync_settings").style.display = "block";
          isRuleSet = true;
        } else {
          showError("Please fill all the mandatory fields.");
          isRuleSet = false;
        }
      });

    function showError(msg) {
      document.getElementById("danger-message").innerHTML = msg;
      document.getElementById("danger-message").style.display = "block";
      document.body.scrollTop = 0; // For Safari
      document.documentElement.scrollTop = 0;
      setTimeout(function (param) {
        document.getElementById("danger-message").style.display = "none";
      }, 3000);
    }

    function loadspinner() {
      var opts = {
        lines: 8,
        length: 3,
        width: 2,
        radius: 4,
        corners: 1,
        rotate: 0,
        direction: 1,
        color: "#000",
        speed: 1.5,
        trail: 60,
        shadow: false,
        hwaccel: false,
        className: "spinner",
        zIndex: 2e9,
        top: "auto",
        left: "auto",
      };
      var spinner = new Spinner(opts).spin(
        document.getElementById("spinner_widget")
      );
    }

    app.initialized().then(function (client) {
      window.client = client;
    });
  </script>
</html>
